version: "3.8"

networks:
  tunnel:
  config:
  certbot:
  database:

services:
  api:
    container_name: api
    image: leaf-backend-dev
    restart: always
    command: "sh -c 'uvicorn app.main:app --reload --workers 3 --host 0.0.0.0 --port 8000'"
    # command: "sh -c 'alembic upgrade head && uvicorn app.main:app --reload --workers 3 --host 0.0.0.0 --port 8000'"
    # command: "sh -c 'alembic upgrade head && gunicorn -w 3 -k uvicorn.workers.UvicornWorker app.main:app  --bind 0.0.0.0:8000 --preload --log-level=debug --timeout 120'"
    volumes:
      - ./backend:/backend
      - ../eventbus/src/eventbus:/backend/eventbus
      - ./volumes/config:/home/config
      - ./volumes/ui:/home/ui
    ports:
      - 8000:8000
    expose:
      - 8000
    environment:
      - ENVIRONMENT=${ENVIRONMENT}
      - PROJECT_NAME=${PROJECT_NAME}
      - DOMAIN=${DOMAIN}
      - FIRST_SUPERUSER_EMAIL=${FIRST_SUPERUSER_EMAIL}
      - POSTGRES_USERNAME=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD}
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_ECHO=${DATABASE_ECHO}
      - CF_POLICY_AUD=${CF_POLICY_AUD}
    networks:
      - tunnel
      - config
      - certbot
